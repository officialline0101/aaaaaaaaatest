<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ご予約フォーム</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        /* --- デザイン設定 (前回と同じ) --- */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #3e2b20;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding-top: 20px;
            padding-bottom: 40px;
            color: #4a3b32;
        }
        .container {
            background-color: #fdfdfa;
            border-radius: 12px;
            border: 1px solid #d4af37;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 600px;
            padding: 30px 25px;
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            background: linear-gradient(135deg, #c5a059, #f3d34b, #c5a059);
            color: #3e2b20;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin: -30px -25px 30px -25px;
            font-size: 24px;
            font-family: 'Noto Serif JP', serif;
            font-weight: 700;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            letter-spacing: 1px;
        }
        h1::before, h1::after { content: '✿'; color: #fff; margin: 0 10px; font-size: 0.8em; vertical-align: middle; }
        .label {
            display: flex; align-items: center; flex-wrap: wrap; margin-top: 25px; margin-bottom: 10px;
            font-weight: 700; font-size: 16px; color: #5d4037; border-left: 5px solid #d4af37; padding-left: 10px;
        }
        .sub-label { font-size: 14px; color: #8d6e63; margin-top: 5px; margin-bottom: 5px; display: block; }
        .required-badge { background-color: #d32f2f; color: white; font-size: 11px; padding: 3px 8px; border-radius: 4px; margin-left: 8px; }
        .optional-badge { background-color: #8d6e63; color: white; font-size: 11px; padding: 3px 8px; border-radius: 4px; margin-left: 8px; }
        
        input[type="text"], input[type="date"], select, textarea {
            width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
            font-size: 16px; transition: all 0.3s; background-color: #fff; font-family: inherit; margin-bottom: 10px;
        }
        input[type="text"], input[type="date"], select { height: 52px; }
        textarea { height: auto; resize: vertical; min-height: 100px; }
        input:focus, select:focus, textarea:focus {
            border-color: #d4af37; background-color: #fffff8; outline: none; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }
        
        .datetime-group { background-color: #fffbf0; padding: 10px; border-radius: 8px; border: 1px dashed #d4af37; margin-bottom: 15px; }
        .datetime-row { display: flex; gap: 10px; }
        .datetime-row > * { flex: 1; }
        
        .selection-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .selection-group button {
            flex: 1 1 30%; padding: 12px 5px; border: 1px solid #d4af37; border-radius: 6px;
            background-color: #fff; color: #5d4037; cursor: pointer; font-size: 14px; transition: all 0.2s;
        }
        .selection-group button:hover { background-color: #fff8e1; }
        .selection-group button.active {
            background-color: #d4af37; color: #fff; border-color: #d4af37; font-weight: bold; transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #other-input-area { display: none; margin-top: 10px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 送信中のローディング用スタイル */
        .submit-button {
            width: 100%; padding: 18px; border: none; border-radius: 50px;
            background: linear-gradient(to bottom, #2ecc71, #218c54); color: #fff;
            font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 40px;
            transition: all 0.3s; box-shadow: 0 4px 0 #1e6e42, 0 5px 10px rgba(0,0,0,0.2);
        }
        .submit-button:disabled {
            background: #ccc; box-shadow: none; cursor: not-allowed;
        }
        .submit-button:active { transform: translateY(4px); box-shadow: none; }
        
        .info-text {
            font-size: 14px; color: #5d4037; background-color: #f9f2e7;
            padding: 15px; border-left: 4px solid #d4af37; border-radius: 4px; margin-bottom: 25px; line-height: 1.8;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ご予約フォーム</h1>
        <div class="info-text">
            ご予約ありがとうございます。<br>
            ご希望の日時を選択し、【送信】ボタンを押してください。
        </div>

        <div class="label">お名前<span class="required-badge">必須</span></div>
        <input type="text" id="name" placeholder="例：山田 花子">

        <div class="label">希望日時<span class="required-badge">必須</span></div>
        
        <div class="sub-label">第一希望</div>
        <div class="datetime-group">
            <div class="datetime-row">
                <input type="date" id="date1">
                <select id="time1" class="time-select"><option value="">時間を選択</option></select>
            </div>
        </div>

        <div class="sub-label">第二希望 (任意)</div>
        <div class="datetime-group">
            <div class="datetime-row">
                <input type="date" id="date2">
                <select id="time2" class="time-select"><option value="">時間を選択</option></select>
            </div>
        </div>

        <div class="sub-label">第三希望 (任意)</div>
        <div class="datetime-group">
            <div class="datetime-row">
                <input type="date" id="date3">
                <select id="time3" class="time-select"><option value="">時間を選択</option></select>
            </div>
        </div>

        <div class="label">悩まれてる内容<span class="optional-badge">複数選択可</span></div>
        <div class="selection-group" id="worry-group">
            <button type="button" onclick="toggleWorry(this)">人間関係</button>
            <button type="button" onclick="toggleWorry(this)">仕事・キャリア</button>
            <button type="button" onclick="toggleWorry(this)">健康・体調</button>
            <button type="button" onclick="toggleWorry(this)">将来の不安</button>
            <button type="button" onclick="toggleWorry(this)">家庭・パートナー</button>
            <button type="button" id="btn-other" onclick="toggleWorry(this)">その他</button>
        </div>

        <div id="other-input-area">
            <textarea id="other-text" placeholder="その他の内容や、詳細をご自由にご記入ください..."></textarea>
        </div>

        <button id="submitBtn" class="submit-button" onclick="submitForm()">送信</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        // ▼▼▼ ここにGASのURLを貼り付けてください ▼▼▼
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwrMHHhszBWiinWo13uA9i0dKxxEyvkLBuyLq9ReC9uHg6phTF142_-SahnhPiKNmfK4g/exec';
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        document.addEventListener('DOMContentLoaded', function () {
            generateTimeOptions();
            liff.init({
                liffId: '2005254357-zKma9BZk' 
            }).then(() => {
                console.log('LIFF初期化成功');
            }).catch((err) => {
                console.error('LIFF初期化失敗', err);
            });
        });

        // 時間選択肢生成 (09:00〜18:00)
        function generateTimeOptions() {
            const selects = document.querySelectorAll('.time-select');
            const startHour = 9;
            const endHour = 18;
            selects.forEach(select => {
                for (let h = startHour; h <= endHour; h++) {
                    let val00 = `${h.toString().padStart(2, '0')}:00`;
                    select.appendChild(new Option(val00, val00));
                    if(h === endHour) break;
                    let val30 = `${h.toString().padStart(2, '0')}:30`;
                    select.appendChild(new Option(val30, val30));
                }
            });
        }

        function toggleWorry(element) {
            element.classList.toggle('active');
            if (element.id === 'btn-other') {
                const otherArea = document.getElementById('other-input-area');
                if (element.classList.contains('active')) {
                    otherArea.style.display = 'block';
                    otherArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    otherArea.style.display = 'none';
                    document.getElementById('other-text').value = '';
                }
            }
        }

        function getSelectedText(groupId) {
            const container = document.getElementById(groupId);
            const activeButtons = container.querySelectorAll('button.active');
            if (activeButtons.length === 0) return '';
            return Array.from(activeButtons).map(btn => btn.innerText).join('、');
        }

        function formatDateJP(dateStr) {
            if (!dateStr) return "";
            const parts = dateStr.split('-'); 
            return `${parseInt(parts[1])}月${parseInt(parts[2])}日`;
        }

        // 送信処理
        function submitForm() {
            const name = document.getElementById('name').value;
            const date1 = document.getElementById('date1').value;
            const time1 = document.getElementById('time1').value;
            const date2 = document.getElementById('date2').value;
            const time2 = document.getElementById('time2').value;
            const date3 = document.getElementById('date3').value;
            const time3 = document.getElementById('time3').value;

            // バリデーション
            if (!name) { alert('「お名前」を入力してください。'); return; }
            if (!date1 || !time1) { alert('第一希望の「日付」と「時間」を両方選択してください。'); return; }

            // ボタン連打防止
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = '送信中...';

            // 悩みデータの作成
            let worries = getSelectedText('worry-group');
            const otherBtn = document.getElementById('btn-other');
            const otherText = document.getElementById('other-text').value;
            if (otherBtn.classList.contains('active') && otherText.trim() !== "") {
                 worries += `\n(詳細: ${otherText})`;
            }

            // 表示用日時文字列
            const dtStr1 = (date1 && time1) ? `${formatDateJP(date1)} ${time1}` : (date1 || time1 ? '日付か時間未選択' : 'なし');
            const dtStr2 = (date2 && time2) ? `${formatDateJP(date2)} ${time2}` : 'なし';
            const dtStr3 = (date3 && time3) ? `${formatDateJP(date3)} ${time3}` : 'なし';

            // LINEトーク送信用のメッセージ
            const lineMsg = `【ご予約フォーム】\n` +
                            `\n[お名前]\n${name}` +
                            `\n\n[希望時間]\n1. ${dtStr1}\n2. ${dtStr2}\n3. ${dtStr3}` +
                            `\n\n[悩まれてる内容]\n${worries || '特になし'}`;

            // GASへ送信するデータオブジェクト
            const postData = {
                name: name,
                datetime1: dtStr1,
                datetime2: dtStr2,
                datetime3: dtStr3,
                worries: worries || '特になし'
            };

            // GASへの送信処理
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(postData)
                // mode: 'no-cors' はエラーが見えなくなるため、通常モードで試行します
            })
            .then(response => {
                // GASへの送信成功後、LINEへメッセージ送信
                sendLineMessage(lineMsg);
            })
            .catch(error => {
                console.error('GAS Error:', error);
                alert('予約データの保存に失敗しましたが、LINEメッセージ送信を試みます。');
                sendLineMessage(lineMsg); // GAS失敗時もとりあえずLINEは送る
            });
        }

        // LINEメッセージ送信関数
        function sendLineMessage(msg) {
            if (!liff.isInClient()) {
                alert('送信完了しました！\n(LINE外のためメッセージ送信はスキップされました)');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').innerText = '送信';
            } else {
                liff.sendMessages([{
                    type: 'text',
                    text: msg
                }]).then(() => {
                    alert('送信しました。');
                    liff.closeWindow();
                }).catch((err) => {
                    console.error('LINE Send Error', err);
                    alert('メッセージ送信に失敗しました。');
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').innerText = '送信';
                });
            }
        }
    </script>
</body>
</html>
