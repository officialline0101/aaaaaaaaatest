<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flower Reservation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. Base Variables & Reset (Material 3 Inspired)
           ========================================= */
        :root {
            --primary: #546e7a;       /* çŸ¥çš„ã§è½ã¡ç€ã„ãŸãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ */
            --accent: #d81b60;        /* è¯ã‚„ã‹ãªã‚¢ã‚¯ã‚»ãƒ³ãƒˆãƒ”ãƒ³ã‚¯ */
            --bg-body: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --error: #b00020;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-float: 0 8px 30px rgba(0,0,0,0.12);
            --radius-L: 16px;
            --radius-S: 8px;
            --header-height: 60px;
            --footer-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0 0 calc(var(--footer-height) + 20px) 0; /* ãƒ•ãƒƒã‚¿ãƒ¼è¢«ã‚Šé˜²æ­¢ */
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã™ã‚Šã‚¬ãƒ©ã‚¹é¢¨ï¼‰ */
        .header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header h1 {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            color: var(--primary);
            letter-spacing: 0.05em;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 16px;
        }

        /* =========================================
           2. Components
           ========================================= */
        
        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã— */
        .section-title {
            font-size: 15px;
            font-weight: 700;
            margin: 32px 0 12px 0;
            color: var(--primary);
            display: flex;
            align-items: center;
        }
        .section-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 18px;
            background: var(--accent);
            margin-right: 10px;
            border-radius: 2px;
        }
        .badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: auto;
            font-weight: 500;
        }
        .badge.req { background: #ffebee; color: var(--error); }
        .badge.opt { background: #eceff1; color: var(--text-sub); }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        /* ç”»åƒã‚«ãƒ¼ãƒ‰ */
        .img-card {
            background: var(--card-bg);
            border-radius: var(--radius-L);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .img-card:active { transform: scale(0.96); }
        
        /* é¸æŠçŠ¶æ…‹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .img-card.selected {
            border-color: var(--accent);
            background-color: #fdf2f6; /* æ¥µè–„ã„ãƒ”ãƒ³ã‚¯ */
        }
        .img-card.selected::after {
            content: 'âœ”';
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .img-wrapper {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            background: #eee;
        }
        .img-wrapper img {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
        }
        
        /* ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .card-info {
            padding: 10px;
            text-align: center;
        }
        .item-name { display: block; font-size: 13px; font-weight: 700; color: var(--text-main); }
        .item-price { display: block; font-size: 11px; color: var(--text-sub); margin-top: 2px; }

        /* ãƒ”ãƒ«ãƒœã‚¿ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰ */
        .pill-wrapper { display: flex; flex-wrap: wrap; gap: 8px; }
        .pill {
            padding: 10px 18px;
            background: var(--card-bg);
            border: 1px solid #e0e0e0;
            border-radius: 30px;
            font-size: 13px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .pill.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 10px rgba(216, 27, 96, 0.3);
            font-weight: 700;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ› */
        .form-group { margin-bottom: 16px; }
        .form-control {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 1px solid #cfd8dc;
            border-radius: var(--radius-S);
            background: #fff;
            appearance: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(84, 110, 122, 0.1);
        }
        /* ã‚¨ãƒ©ãƒ¼æ™‚ã®æŒ¯å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ */
        .form-control.error {
            border-color: var(--error);
            background: #ffebee;
            animation: shake 0.4s;
        }

        /* å•†å“è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é¢¨ï¼‰ */
        .detail-box {
            background: #e1f5fe;
            padding: 16px;
            border-radius: var(--radius-S);
            font-size: 13px;
            color: #0277bd;
            margin-bottom: 20px;
            display: none; /* åˆæœŸéè¡¨ç¤º */
            line-height: 1.7;
            border-left: 4px solid #0288d1;
        }

        /* =========================================
           3. Sticky Bottom Footer (Conversion Area)
           ========================================= */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--footer-height);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 10px 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .total-display {
            display: flex;
            flex-direction: column;
        }
        .total-label { font-size: 10px; color: var(--text-sub); }
        .total-amount { font-size: 22px; font-weight: 700; color: var(--text-main); font-feature-settings: "palt"; }
        .total-amount span { font-size: 12px; margin-left: 2px; font-weight: normal; }

        .submit-btn {
            background: var(--text-main); /* é«˜ç´šæ„Ÿã®ã‚ã‚‹é»’/æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
            color: white;
            border: none;
            padding: 0 32px;
            height: 48px;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.2s, background 0.2s;
        }
        .submit-btn:active { transform: scale(0.95); background: #000; }

        /* =========================================
           4. Notifications & Animations
           ========================================= */
        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(33, 33, 33, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            z-index: 2000;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease forwards; }

    </style>
</head>
<body>

    <header class="header">
        <h1>Flower Reservation</h1>
    </header>

    <div class="container">
        
        <div id="step-1" class="fade-in">
            <div class="section-title">â¶ åº—èˆ—ã‚’é¸æŠ<span class="badge req">å¿…é ˆ</span></div>
            <div class="pill-wrapper">
                <div class="pill" onclick="selectStore(this, 'å¤§é˜ªåº—')">å¤§é˜ªåº—</div>
                <div class="pill" onclick="selectStore(this, 'å¥ˆè‰¯åº—')">å¥ˆè‰¯åº—</div>
            </div>
        </div>

        <div id="step-2" style="opacity:0.4; pointer-events:none; transition:opacity 0.4s; margin-top:20px;">
            <div class="section-title">â· å•†å“ã‚¿ã‚¤ãƒ—<span class="badge req">å¿…é ˆ</span></div>
            <div class="grid-2">
                <div class="img-card" onclick="selectCategory(this, 'bouquet')">
                    <div class="img-wrapper">
                        <img src="https://images.unsplash.com/photo-1562690868-60bbe7293e94?auto=format&fit=crop&w=500&q=80" alt="èŠ±æŸ">
                    </div>
                    <div class="card-info">
                        <span class="item-name">èŠ±æŸ</span>
                        <span class="item-price">Bouquet</span>
                    </div>
                </div>
                <div class="img-card" onclick="selectCategory(this, 'arrangement')">
                    <div class="img-wrapper">
                        <img src="https://images.unsplash.com/photo-1586182598818-80df2445b23a?auto=format&fit=crop&w=500&q=80" alt="ã‚¢ãƒ¬ãƒ³ã‚¸">
                    </div>
                    <div class="card-info">
                        <span class="item-name">ã‚¢ãƒ¬ãƒ³ã‚¸ãƒ¡ãƒ³ãƒˆ</span>
                        <span class="item-price">Arrangement</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="step-3" style="display:none;" class="fade-in">
            <div class="section-title">â¸ ã”äºˆç®—<span class="badge req">å¿…é ˆ</span></div>
            <div id="price-container" class="pill-wrapper"></div>
        </div>

        <div id="detail-text" class="detail-box fade-in"></div>

        <div id="step-optional" style="display:none;" class="fade-in">
            
            <div id="style-section" style="display:none;">
                <div class="section-title">â¹ ã‚¹ã‚¿ã‚¤ãƒ«<span class="badge opt">ä»»æ„</span></div>
                <div class="grid-2" id="style-container"></div>
            </div>

            <div class="section-title">âº è‰²åˆã„<span class="badge opt">ä»»æ„</span></div>
            <div class="grid-3" id="color-container"></div>

            <div class="section-title">â» ã‚¤ãƒ¡ãƒ¼ã‚¸<span class="badge opt">ä»»æ„</span></div>
            <div class="grid-2" id="image-container"></div>

            <div class="section-title">â¼ ç”¨é€”<span class="badge opt">ä»»æ„</span></div>
            <div class="pill-wrapper" id="usage-container"></div>

            <div class="section-title">â½ ã‚ªãƒ—ã‚·ãƒ§ãƒ³<span class="badge req">å¿…é ˆ</span></div>
            <div class="grid-2" id="option-container"></div>
        </div>

        <div id="step-final" style="display:none;" class="fade-in">
            <div class="section-title">â¾ å—å–æ—¥æ™‚<span class="badge req">å¿…é ˆ</span></div>
            <div class="grid-2">
                <div class="form-group">
                    <select id="pickup-date" class="form-control" onchange="updateTimeOptions()">
                        <option value="">æ—¥ä»˜ã‚’é¸æŠ</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="pickup-time" class="form-control">
                        <option value="">æ™‚é–“ã‚’é¸æŠ</option>
                    </select>
                </div>
            </div>

            <div class="section-title">ãŠå®¢æ§˜æƒ…å ±<span class="badge req">å¿…é ˆ</span></div>
            <div class="form-group">
                <input type="text" id="name" class="form-control" placeholder="ãŠåå‰" oninput="removeError(this)">
            </div>
            <div class="form-group">
                <input type="tel" id="phone" class="form-control" placeholder="é›»è©±ç•ªå· (ãƒã‚¤ãƒ•ãƒ³ä¸è¦)" oninput="removeError(this)">
            </div>
            <div class="form-group">
                <textarea id="message" class="form-control" rows="3" placeholder="ãã®ä»–ã”è¦æœ›ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ã®å†…å®¹ãªã©"></textarea>
            </div>
        </div>

    </div>

    <div class="sticky-footer">
        <div class="total-display">
            <span class="total-label">ãŠæ”¯æ‰•ã„ç›®å®‰</span>
            <span class="total-amount" id="footer-total">0<span>å††</span></span>
        </div>
        <button class="submit-btn" onclick="submitForm()">äºˆç´„ã™ã‚‹</button>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

    <script>
        // ==========================================
        //  ãƒ‡ãƒ¼ã‚¿å®šç¾©
        // ==========================================
        const SHOP_DATA = {
            styles: [
                { name: 'ãƒ­ãƒ³ã‚°', img: 'https://images.unsplash.com/photo-1599818451121-6d73f47e3240?auto=format&fit=crop&w=400&q=80' },
                { name: 'ãƒ–ãƒ¼ã‚±', img: 'https://images.unsplash.com/photo-1596232533039-44673854749f?auto=format&fit=crop&w=400&q=80' }
            ],
            colors: [
                { name: 'ç™½ã‚°ãƒªãƒ¼ãƒ³', img: 'https://images.unsplash.com/photo-1516205651411-a41674526547?auto=format&fit=crop&w=400&q=80' },
                { name: 'ã‚¤ã‚¨ãƒ­ãƒ¼', img: 'https://images.unsplash.com/photo-1525310072745-f49212b5ac6d?auto=format&fit=crop&w=400&q=80' },
                { name: 'ãƒ”ãƒ³ã‚¯', img: 'https://images.unsplash.com/photo-1494959764136-6be9eb3c261e?auto=format&fit=crop&w=400&q=80' },
                { name: 'ãƒ¬ãƒƒãƒ‰', img: 'https://images.unsplash.com/photo-1597826368522-9f4a3386e5f0?auto=format&fit=crop&w=400&q=80' },
                { name: 'ãƒ–ãƒ«ãƒ¼ç´«', img: 'https://images.unsplash.com/photo-1563241527-4a0b22a61176?auto=format&fit=crop&w=400&q=80' },
                { name: 'ãŠã¾ã‹ã›', img: 'https://images.unsplash.com/photo-1507290439931-a861b5a38200?auto=format&fit=crop&w=400&q=80' }
            ],
            images: [
                { name: 'å¯æ„›ã„', img: 'https://images.unsplash.com/photo-1520302630591-a6e3b0db29b7?auto=format&fit=crop&w=400&q=80' },
                { name: 'ã‚·ãƒƒã‚¯', img: 'https://images.unsplash.com/photo-1509623284013-030fd95d8200?auto=format&fit=crop&w=400&q=80' },
                { name: 'ãƒŠãƒãƒ¥ãƒ©ãƒ«', img: 'https://images.unsplash.com/photo-1457089328109-e5d9bd499191?auto=format&fit=crop&w=400&q=80' },
                { name: 'å­£ç¯€ã®èŠ±', img: 'https://images.unsplash.com/photo-1582794543139-8ac92a9ab5d9?auto=format&fit=crop&w=400&q=80' }
            ],
            usages: ['èª•ç”Ÿæ—¥', 'é€åˆ¥', 'è¨˜å¿µæ—¥', 'ç™ºè¡¨ä¼š', 'ãŠä¾›ãˆ', 'è‡ªåˆ†ç”¨'],
            options: [
                { name: 'ã‚«ãƒ¼ãƒ‰', price: 250, img: 'https://images.unsplash.com/photo-1516972238977-89271fb2bab8?auto=format&fit=crop&w=400&q=80' },
                { name: 'ãƒ©ãƒƒãƒ”ãƒ³ã‚°', price: 300, img: 'https://images.unsplash.com/photo-1544816155-12df9643f363?auto=format&fit=crop&w=400&q=80' },
                { name: 'æŒã¡å¸°ã‚Šè¢‹', price: 100, img: 'https://images.unsplash.com/photo-1627464222036-7c919a32c2a0?auto=format&fit=crop&w=400&q=80' },
                { name: 'ç„¡ã—', price: 0, img: 'https://placehold.co/400x300/eee/999?text=None' }
            ],
            prices: {
                bouquet: [3300, 4400, 5500, 8800, 11000],
                arrangement: [3300, 4400, 5500, 8800, 11000]
            },
            details: {
                bouquet: { base: "<b>èŠ±æŸ</b>ï¼šå­£ç¯€ã®èŠ±æã‚’æŸã­ã€ä¿æ°´å‡¦ç†ã‚’ã—ã¦ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚", small: "æ‰‹é ƒãªã‚µã‚¤ã‚ºã§ã¡ã‚‡ã£ã¨ã—ãŸãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã«æœ€é©ã€‚", large: "ä¸¡æ‰‹ã§æŠ±ãˆã‚‹ã»ã©ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ æ„Ÿã€‚ç‰¹åˆ¥ãªæ—¥ã«ã€‚" },
                arrangement: { base: "<b>ã‚¢ãƒ¬ãƒ³ã‚¸ãƒ¡ãƒ³ãƒˆ</b>ï¼šå¸æ°´ã‚¹ãƒãƒ³ã‚¸ã«æŒ¿ã—ãŸã‚¹ã‚¿ã‚¤ãƒ«ã€‚èŠ±ç“¶ä¸è¦ã§ãã®ã¾ã¾é£¾ã‚Œã¾ã™ã€‚", small: "é£Ÿå“ã‚„ãƒ‡ã‚¹ã‚¯ã«é£¾ã‚Œã‚‹ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚µã‚¤ã‚ºã€‚", large: "é–‹åº—ç¥ã„ã‚„è¬›æ¼”ä¼šãªã©ã€è¯ã‚„ã‹ãªã‚·ãƒ¼ãƒ³ã«ã€‚" }
            }
        };

        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒ†ãƒ¼ãƒˆ
        const order = {
            store: null, category: null, price: 0, style: null, color: null, image: null, usage: null, options: [],
            date: null, time: null
        };

        // ==========================================
        //  åˆæœŸåŒ–ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            liff.init({ liffId: 'YOUR_LIFF_ID' }).catch(e => console.log('LIFF init error', e));
            initDateSelect();
            renderStaticItems();
        });

        function renderStaticItems() {
            // ã‚¹ã‚¿ã‚¤ãƒ«ã€è‰²ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ç”¨é€”ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æç”»
            renderCards('style-container', SHOP_DATA.styles, 'selectStyle');
            renderCards('color-container', SHOP_DATA.colors, 'selectColor');
            renderCards('image-container', SHOP_DATA.images, 'selectImage');
            renderPills('usage-container', SHOP_DATA.usages, 'selectUsage');
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè¤‡æ•°é¸æŠï¼‰ã¯ç‰¹æ®Šæç”»
            const optContainer = document.getElementById('option-container');
            SHOP_DATA.options.forEach(item => {
                const div = document.createElement('div');
                div.className = 'img-card';
                div.onclick = () => selectOptionMulti(div, item.name, item.price);
                div.innerHTML = `
                    <div class="img-wrapper"><img src="${item.img}" alt="${item.name}" loading="lazy"></div>
                    <div class="card-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">${item.price > 0 ? '+' + item.price + 'å††' : 'Â¥0'}</span>
                    </div>`;
                optContainer.appendChild(div);
            });
        }

        function renderCards(id, data, fnName) {
            const el = document.getElementById(id);
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'img-card';
                div.onclick = () => window[fnName](div, item.name);
                div.innerHTML = `
                    <div class="img-wrapper"><img src="${item.img}" alt="${item.name}" loading="lazy"></div>
                    <div class="card-info"><span class="item-name">${item.name}</span></div>`;
                el.appendChild(div);
            });
        }

        function renderPills(id, list, fnName) {
            const el = document.getElementById(id);
            list.forEach(txt => {
                const div = document.createElement('div');
                div.className = 'pill';
                div.innerText = txt;
                div.onclick = () => window[fnName](div, txt);
                el.appendChild(div);
            });
        }

        // ==========================================
        //  ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã“ã“ãŒUXã®è‚ï¼‰
        // ==========================================
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šé¸æŠçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
        function activate(el, selector) {
            el.parentElement.querySelectorAll(selector).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šæ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆè‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
        function scrollToId(id) {
            setTimeout(() => {
                const el = document.getElementById(id);
                el.style.display = 'block';
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ†ã‚’è€ƒæ…®ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
                const offset = 80; 
                const y = el.getBoundingClientRect().top + window.scrollY - offset;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }, 300); // é¸æŠã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«å°‘ã—å¾…ã¤
        }

        // STEP 1: åº—èˆ—é¸æŠ
        window.selectStore = (el, val) => {
            activate(el, '.pill');
            order.store = val;
            
            // STEP 2ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
            const s2 = document.getElementById('step-2');
            s2.style.opacity = '1';
            s2.style.pointerEvents = 'auto';
            scrollToId('step-2');
        };

        // STEP 2: å•†å“é¸æŠ
        window.selectCategory = (el, val) => {
            activate(el, '.img-card');
            order.category = val;
            order.price = 0; // ãƒªã‚»ãƒƒãƒˆ
            
            // é‡‘é¡ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
            const pCont = document.getElementById('price-container');
            pCont.innerHTML = '';
            SHOP_DATA.prices[val].forEach(price => {
                const btn = document.createElement('div');
                btn.className = 'pill';
                btn.innerText = price.toLocaleString() + 'å††';
                btn.onclick = () => selectPrice(btn, price);
                pCont.appendChild(btn);
            });

            // è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’éš ã™ï¼ˆå†é¸æŠæ™‚ç”¨ï¼‰
            document.getElementById('detail-text').style.display = 'none';

            scrollToId('step-3');
        };

        // STEP 3: é‡‘é¡é¸æŠ
        function selectPrice(el, val) {
            activate(el, '.pill');
            order.price = val;
            updateFooter(); // é‡‘é¡æ›´æ–°
            
            // å•†å“èª¬æ˜ã‚’è¡¨ç¤º
            const dBox = document.getElementById('detail-text');
            dBox.style.display = 'block';
            let txt = SHOP_DATA.details[order.category].base;
            const prices = SHOP_DATA.prices[order.category];
            // é‡‘é¡ã«å¿œã˜ãŸèª¬æ˜æ–‡ã®å‡ºã—åˆ†ã‘
            if (val <= prices[1]) txt += "<br>ğŸ’¡ " + SHOP_DATA.details[order.category].small;
            else if (val >= prices[prices.length - 2]) txt += "<br>âœ¨ " + SHOP_DATA.details[order.category].large;
            dBox.innerHTML = txt;

            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            const styleSec = document.getElementById('style-section');
            styleSec.style.display = (order.category === 'bouquet') ? 'block' : 'none';
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            scrollToId('step-optional');
        }

        // STEP 4: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç¾¤
        window.selectStyle = (el, v) => { activate(el, '.img-card'); order.style = v; };
        window.selectColor = (el, v) => { activate(el, '.img-card'); order.color = v; };
        window.selectImage = (el, v) => { activate(el, '.img-card'); order.image = v; };
        
        // ç”¨é€”ã‚’é¸ã‚“ã ã‚‰æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ—¥æ™‚ãƒ»æƒ…å ±ï¼‰ã¸èª˜å°
        window.selectUsage = (el, v) => { 
            activate(el, '.pill'); 
            order.usage = v; 
            scrollToId('step-final'); 
        };

        // è¤‡æ•°é¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³
        window.selectOptionMulti = (el, name, price) => {
            if (name === 'ç„¡ã—') {
                order.options = [];
                // ä»–ã®é¸æŠã‚’è§£é™¤
                const sibs = el.parentElement.querySelectorAll('.img-card');
                sibs.forEach(s => s.classList.remove('selected'));
                el.classList.add('selected');
            } else {
                // "ç„¡ã—"ãƒœã‚¿ãƒ³ã®é¸æŠã‚’è§£é™¤
                const noneBtn = Array.from(el.parentElement.children).find(c => c.innerText.includes('ç„¡ã—'));
                if(noneBtn) noneBtn.classList.remove('selected');

                // ãƒˆã‚°ãƒ«å‡¦ç†
                if (el.classList.contains('selected')) {
                    el.classList.remove('selected');
                    order.options = order.options.filter(o => o.name !== name);
                } else {
                    el.classList.add('selected');
                    order.options.push({ name, price });
                }
            }
            updateFooter();
        };

        // ==========================================
        //  æ—¥ä»˜ãƒ»æ™‚é–“ãƒ­ã‚¸ãƒƒã‚¯
        // ==========================================
        function initDateSelect() {
            const sel = document.getElementById('pickup-date');
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const val = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
                const w = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
                const txt = `${d.getMonth()+1}/${d.getDate()} (${w})`;
                const opt = document.createElement('option');
                opt.value = val;
                opt.innerText = txt;
                sel.appendChild(opt);
            }
        }

        window.updateTimeOptions = () => {
            const dateVal = document.getElementById('pickup-date').value;
            const timeSel = document.getElementById('pickup-time');
            timeSel.innerHTML = '<option value="">æ™‚é–“ã‚’é¸æŠ</option>';
            if (!dateVal) return;

            const start = 10; const end = 19;
            for (let h = start; h <= end; h++) {
                timeSel.innerHTML += `<option value="${h}:00">${h}:00</option>`;
                timeSel.innerHTML += `<option value="${h}:30">${h}:30</option>`;
            }
        };

        // ==========================================
        //  ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»é€ä¿¡ï¼ˆã“ã“ãŒã‚¨ãƒ©ãƒ¼å¯¾å¿œã®è‚ï¼‰
        // ==========================================
        
        // ãƒ•ãƒƒã‚¿ãƒ¼é‡‘é¡æ›´æ–°
        function updateFooter() {
            const optTotal = order.options.reduce((s, o) => s + o.price, 0);
            const total = order.price + optTotal;
            document.getElementById('footer-total').innerHTML = total.toLocaleString() + '<span>å††</span>';
        }

        // å…¥åŠ›æ™‚ã«ã‚¨ãƒ©ãƒ¼è§£é™¤
        window.removeError = (el) => {
            el.classList.remove('error');
        };
        
        window.submitForm = () => {
            // å¿…é ˆé …ç›®ãƒªã‚¹ãƒˆ
            const required = [
                { val: order.store, el: document.getElementById('step-1') },
                { val: order.category, el: document.getElementById('step-2') },
                { val: order.price, el: document.getElementById('price-container') },
                { val: document.getElementById('pickup-date').value, el: document.getElementById('pickup-date') },
                { val: document.getElementById('pickup-time').value, el: document.getElementById('pickup-time') },
                { val: document.getElementById('name').value, el: document.getElementById('name') },
                { val: document.getElementById('phone').value, el: document.getElementById('phone') }
            ];

            let hasError = false;
            let firstErrorEl = null;

            for (const item of required) {
                if (!item.val) {
                    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå‡¦ç†
                    if (item.el.classList.contains('form-control')) {
                        item.el.classList.add('error'); // èµ¤æ ï¼‹æŒ¯å‹•
                    }
                    if(!hasError) firstErrorEl = item.el;
                    hasError = true;
                }
            }
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠæ¼ã‚Œãƒã‚§ãƒƒã‚¯ï¼ˆ"ç„¡ã—"ã‚‚å«ã‚ã¦ä½•ã‹ãŒé¸ã°ã‚Œã¦ã„ã‚‹ã‹ï¼‰
            const optDiv = document.getElementById('option-container');
            const hasOptionSelected = Array.from(optDiv.children).some(c => c.classList.contains('selected'));
            if (!hasOptionSelected) {
                hasError = true;
                if(!firstErrorEl) firstErrorEl = optDiv;
            }

            if (hasError) {
                // æœ€åˆã®ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if(firstErrorEl) {
                    const offset = 100;
                    const y = firstErrorEl.getBoundingClientRect().top + window.scrollY - offset;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                }
                showToast("âš ï¸ æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™");
                return;
            }

            // æˆåŠŸæ™‚ã®å‡¦ç†
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const msgBody = document.getElementById('message').value;
            const date = document.getElementById('pickup-date').value;
            const time = document.getElementById('pickup-time').value;

            const total = order.price + order.options.reduce((s,o)=>s+o.price,0);
            const opts = order.options.map(o=>o.name).join(', ') || 'ç„¡ã—';

            const lineMsg = `ã€æ³¨æ–‡ç¢ºå®šã€‘
åº—èˆ—: ${order.store}
å•†å“: ${order.category === 'bouquet'?'èŠ±æŸ':'ã‚¢ãƒ¬ãƒ³ã‚¸'}
é‡‘é¡: ${order.price.toLocaleString()}å††
è©³ç´°: ${order.style||'-'} / ${order.color||'-'} / ${order.image||'-'}
ç”¨é€”: ${order.usage||'-'}
OP: ${opts}
æ—¥æ™‚: ${date} ${time}
æ°å: ${name}
é›»è©±: ${phone}
å‚™è€ƒ: ${msgBody}
----------------
åˆè¨ˆ: ${total.toLocaleString()}å††`;

            if (liff.isInClient()) {
                liff.sendMessages([{ type: 'text', text: lineMsg }])
                    .then(() => liff.closeWindow())
                    .catch((e) => showToast("âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e));
            } else {
                // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆPCãƒ–ãƒ©ã‚¦ã‚¶ãªã©ï¼‰
                console.log(lineMsg);
                showToast("âœ… äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
                // alert(lineMsg); 
            }
        };

        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            // 3ç§’å¾Œã«æ¶ˆãˆã‚‹
            setTimeout(() => t.classList.remove('show'), 3000);
        }

    </script>
</body>
</html>
