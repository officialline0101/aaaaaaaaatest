<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUCはりきゅう治療院予約フォーム</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        /* 基本スタイル */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding-top: 5px;
            overflow-x: hidden;
        }

        .container {
            background-color: #fdfdfd;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 96%;
            max-width: 500px;
            padding: 25px;
            box-sizing: border-box;
            margin: 0 auto 20px auto;
        }

        /* ヘッダー周り */
        h1 {
            background: linear-gradient(135deg, #002a60, #002a60);
            color: white;
            padding: 20px;
            border-radius: 0 0 0 0;
            text-align: center;
            display: block;
            margin: -25px -25px 25px -25px;
            font-size: 22px;
            font-weight: bold;
            box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.05);
        }

        /* ラベルスタイル */
        .label, .labelkibounitizi, .labelmessezi, .labeltyuuou {
            display: block;
            margin-bottom: 15px;
            padding: 8px;
            font-weight: 400;
            background-color: #002a60;
            color: #ffffff;
            font-size: 16px;
            text-align: center;
            position: relative;
            border-top: 1px solid black;
            border-bottom: 1px solid black;
        }
        
        .labelkibounitizi {
            margin-top: 20px;
            margin-bottom: 5px;
        }

        /* 必須マーク */
        .required {
            color: #ffffff;
            font-weight: lighter;
            font-size: 0.7em;
            margin-left: 8px;
            vertical-align: 0.1em;
            background-color: rgb(255, 15, 15);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* 入力フォーム */
        input[type="text"],
        input[type="tel"],
        textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #555555;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        /* ボタンエリア（施術時間） */
        .time-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-buttons button {
            flex: 1;
            padding: 15px;
            border: 1px solid #2e2e2e;
            border-radius: 4px;
            background-color: #f7f7f7;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            transition: all 0.3s;
        }

        .time-buttons button.active {
            background-color: #3e3f41;
            color: #ffffff;
            border-color: #3e3f41;
            transform: scale(1.02);
        }

        /* 日時入力エリア */
        .datetime-wrapper {
            margin-bottom: 15px;
        }
        
        .dt-grid {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .datetime-input {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 1px solid #000000;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: #fff;
            color: #333;
            appearance: none;
            text-align: center;
        }
        
        .dt-grid select {
            flex: 1;
        }

        .time-disabled {
            opacity: 0.5;
            pointer-events: none;
            background-color: #e0e0e0;
        }

        /* 注意書き */
        .note-text {
            font-size: 13px;
            color: #d93025;
            text-align: left;
            margin-bottom: 10px;
            font-weight: bold;
            display: block;
            padding: 0 10px;
            line-height: 1.4;
        }

        /* 送信ボタン */
        .submit-button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background-color: #002a60;
            border: none;
            border-radius: 6px;
            color: #fff;
            margin-top: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-button:hover {
            opacity: 0.9;
        }

        /* 確認表示エリア */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-row p {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .edit-button {
            background-color: #ffffff;
            color: #1a1a1a;
            border: 1px solid black;
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        /* スマホ用調整 */
        @media (max-width: 480px) {
            .dt-grid {
                flex-direction: column;
            }
            .label {
                font-size: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>TUCはりきゅう治療院<br>予約フォーム</h1>

        <div class="label" id="anchor-name">①お名前<span class="required">必須</span></div>
        <input type="text" id="name" placeholder="お名前を入力してください" oninput="updateDisplayInfo()">

        <div class="label" id="anchor-phone">②お電話番号<span class="required">必須</span></div>
        <input type="tel" id="phone" placeholder="電話番号を入力してください" oninput="updateDisplayInfo()">

        <div class="label" id="anchor-symptoms">③現在の症状<span class="required">必須</span></div>
        <textarea id="symptoms" rows="3" placeholder="腰痛、肩こり、頭痛など&#13;&#10;気になる症状をご記入ください" oninput="updateDisplayInfo()"></textarea>

        <div class="label" id="anchor-course">④希望施術時間<span class="required">必須</span></div>
        <div class="time-buttons">
            <button type="button" onclick="selectCourse('30分', this)">30分</button>
            <button type="button" onclick="selectCourse('60分', this)">60分</button>
        </div>

        <div class="labelkibounitizi" id="anchor-date1">⑤希望日時（第三希望まで）<span class="required">必須</span></div>
        <div class="note-text">
            ※土曜日は17時が最終受付になるので希望時間選択の際はご注意ください。<br>
            ※月曜日・水曜日・金曜日は午前での診察は行なっておりませんので希望時間選択の際はご注意ください。
        </div>

        <div class="datetime-wrapper">
            <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:#555;">第一希望</div>
            <input type="hidden" id="date1">
            <div class="dt-grid">
                <select id="date1_day" class="datetime-input"></select>
                <select id="date1_time" class="datetime-input time-disabled"><option>日付を選択</option></select>
            </div>
        </div>

        <div class="datetime-wrapper">
            <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:#555;">第二希望</div>
            <input type="hidden" id="date2">
            <div class="dt-grid">
                <select id="date2_day" class="datetime-input"></select>
                <select id="date2_time" class="datetime-input time-disabled"><option>日付を選択</option></select>
            </div>
        </div>

        <div class="datetime-wrapper">
            <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:#555;">第三希望</div>
            <input type="hidden" id="date3">
            <div class="dt-grid">
                <select id="date3_day" class="datetime-input"></select>
                <select id="date3_time" class="datetime-input time-disabled"><option>日付を選択</option></select>
            </div>
        </div>

        <div class="labelmessezi">⑥自由記載項目（任意）<br><span style="font-size:12px;">質問等お気軽にご記入ください</span></div>
        <textarea id="message" rows="4" placeholder="メッセージを入力してください" oninput="updateDisplayInfo()"></textarea>

        <div class="labeltyuuou">ご予約内容確認</div>
        <div id="displayInfo">
            <p style="text-align:center; color:#888;">入力内容がここに表示されます</p>
        </div>

        <button class="submit-button" onclick="submitForm()">予約を行う</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        // 設定：希望の時間枠リスト
        const TIME_RANGES = [
            '09:00~13:00',
            '13:50~17:30',
            '17:30~22:00'
        ];

        let selectedCourse = ''; // '30分' or '60分'

        // 初期化処理
        document.addEventListener('DOMContentLoaded', function () {
            // LIFF初期化
            liff.init({
                liffId: '2005254357-zKma9BZk' 
            }).then(() => {
                console.log('LIFF init success');
            }).catch((err) => {
                console.log('LIFF init failed', err);
            });

            // 日付ピッカーの初期化（3つ分）
            initDatePicker('date1');
            initDatePicker('date2');
            initDatePicker('date3');
        });

        // 曜日配列
        const JP_WD = ['日', '月', '火', '水', '木', '金', '土'];

        /**
         * 日付・時間選択の初期化
         * @param {string} baseId - "date1", "date2", "date3"
         */
        function initDatePicker(baseId) {
            const daySel = document.getElementById(`${baseId}_day`);
            const timeSel = document.getElementById(`${baseId}_time`);

            // 日付リスト生成（今日から120日分）
            const today = new Date();
            daySel.innerHTML = '<option value="" disabled selected>日付を選択</option>';

            for (let i = 0; i < 120; i++) {
                const d = new Date();
                d.setDate(today.getDate() + i);
                const wd = d.getDay(); // 0:日, 1:月 ... 6:土

                // 木曜日(4)と日曜日(0)は定休日のため除外
                if (wd === 0 || wd === 4) continue;

                const y = d.getFullYear();
                const m = ('0' + (d.getMonth() + 1)).slice(-2);
                const day = ('0' + d.getDate()).slice(-2);
                const val = `${y}-${m}-${day}`;
                const label = `${m}/${day}（${JP_WD[wd]}）`;

                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = label;
                daySel.appendChild(opt);
            }

            // 日付変更時のイベント
            daySel.addEventListener('change', function() {
                const dateVal = this.value;
                if (!dateVal) return;

                const selectedDate = new Date(dateVal);
                const wd = selectedDate.getDay();

                // 時間リストを再生成（曜日による制限を適用）
                buildTimeOptions(timeSel, wd);

                // 時間選択を有効化
                timeSel.classList.remove('time-disabled');
                
                // hidden値更新
                updateHiddenValue(baseId);
                updateDisplayInfo();
            });

            // 時間変更時のイベント
            timeSel.addEventListener('change', function() {
                updateHiddenValue(baseId);
                updateDisplayInfo();
            });
        }

        /**
         * 時間の選択肢を生成する（曜日制限付き）
         * @param {HTMLElement} selectEl 
         * @param {number} weekday - 曜日インデックス (0-6)
         */
        function buildTimeOptions(selectEl, weekday) {
            selectEl.innerHTML = '<option value="" disabled selected>時間を選択</option>';

            TIME_RANGES.forEach(timeStr => {
                const startHour = parseInt(timeStr.split(':')[0], 10);

                // 土曜日(6)の場合の制限
                // 17時最終受付なので、17:00以降(17:30~)に開始する枠は表示しない
                if (weekday === 6) {
                    if (startHour >= 17) {
                        return; // スキップ
                    }
                }

                // 月(1)・水(3)・金(5)の場合の制限
                // 午前中(13時以前)の診察は行っていないため、9:00~13:00を除外
                if (weekday === 1 || weekday === 3 || weekday === 5) {
                    if (startHour < 13) {
                        return; // スキップ
                    }
                }

                const opt = document.createElement('option');
                opt.value = timeStr;
                opt.textContent = timeStr;
                selectEl.appendChild(opt);
            });
        }

        /**
         * 隠しフィールド(日付+時間)を更新
         */
        function updateHiddenValue(baseId) {
            const d = document.getElementById(`${baseId}_day`).value;
            const t = document.getElementById(`${baseId}_time`).value;
            const hidden = document.getElementById(baseId);
            if(d && t) {
                hidden.value = `${d}T${t}`; 
            } else {
                hidden.value = "";
            }
        }

        /**
         * 施術時間ボタン選択処理
         */
        function selectCourse(course, btnElement) {
            selectedCourse = course;
            
            // ボタンの見た目更新
            document.querySelectorAll('.time-buttons button').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            updateDisplayInfo();
        }

        /**
         * 表示内容の更新（ご予約内容確認エリア）
         */
        function updateDisplayInfo() {
            const name = document.getElementById('name').value;
            const symptoms = document.getElementById('symptoms').value;
            const courseText = selectedCourse ? selectedCourse : '<span style="color:#aaa;">未選択</span>';
            
            // 日時フォーマット関数
            const fmt = (id) => {
                const val = document.getElementById(id).value;
                if(!val) return '<span style="color:#aaa;">未選択</span>';
                const [dPart, tPart] = val.split('T');
                const [y, m, d] = dPart.split('-');
                return `${m}月${d}日 ${tPart}`;
            };

            const html = `
                <div class="info-row">
                    <p><span style="color:#002a60;"><strong>お名前</strong></span><br>${name || '未入力'}</p>
                    <button class="edit-button" onclick="scrollToId('anchor-name')">修正</button>
                </div>
                <div class="info-row">
                    <p><span style="color:#002a60;"><strong>現在の症状</strong></span><br>${symptoms ? (symptoms.length > 20 ? symptoms.substring(0,20)+'...' : symptoms) : '未入力'}</p>
                    <button class="edit-button" onclick="scrollToId('anchor-symptoms')">修正</button>
                </div>
                <div class="info-row">
                    <p><span style="color:#002a60;"><strong>希望施術時間</strong></span><br>${courseText}</p>
                    <button class="edit-button" onclick="scrollToId('anchor-course')">修正</button>
                </div>
                <div class="info-row">
                    <p><span style="color:#002a60;"><strong>第一希望</strong></span><br>${fmt('date1')}</p>
                    <button class="edit-button" onclick="scrollToId('anchor-date1')">修正</button>
                </div>
                <div class="info-row">
                    <p><span style="color:#002a60;"><strong>第二希望</strong></span><br>${fmt('date2')}</p>
                    <button class="edit-button" onclick="scrollToId('anchor-date1')">修正</button>
                </div>
                <div class="info-row">
                    <p><span style="color:#002a60;"><strong>第三希望</strong></span><br>${fmt('date3')}</p>
                    <button class="edit-button" onclick="scrollToId('anchor-date1')">修正</button>
                </div>
            `;
            
            document.getElementById('displayInfo').innerHTML = html;
        }

        // スクロール用
        function scrollToId(id) {
            const el = document.getElementById(id);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        /**
         * 送信処理
         */
        function submitForm() {
            // バリデーション
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const symptoms = document.getElementById('symptoms').value.trim();
            const date1 = document.getElementById('date1').value;
            const date2 = document.getElementById('date2').value;
            const date3 = document.getElementById('date3').value;
            const message = document.getElementById('message').value.trim();

            if (!name) return alert('お名前を入力してください。');
            if (!phone) return alert('電話番号を入力してください。');
            if (!symptoms) return alert('現在の症状を入力してください。');
            if (!selectedCourse) return alert('希望施術時間を選択してください。');
            if (!date1) return alert('第一希望日時は必須です。');
            if (!date2 || !date3) return alert('第三希望まで日時を選択してください。');

            // 送信テキスト作成
            const fmtDate = (isoStr) => {
                if(!isoStr) return 'なし';
                const [d, t] = isoStr.split('T');
                return `${d.replace(/-/g, '/')} ${t}`;
            };

            const text = 
`【TUCはりきゅう治療院予約】
《お名前》
${name}

《電話番号》
${phone}

《現在の症状》
${symptoms}

《希望施術時間》
${selectedCourse}

《希望日時》
第一：${fmtDate(date1)}
第二：${fmtDate(date2)}
第三：${fmtDate(date3)}

《自由記載》
${message}`;

            // LIFF送信
            if (!liff.isInClient()) {
                alert('LINEアプリ外では送信できません。\n\n---送信内容---\n' + text);
                return;
            }

            liff.sendMessages([{
                type: 'text',
                text: text
            }]).then(() => {
                liff.closeWindow();
            }).catch((err) => {
                console.error('送信エラー:', err);
                alert('送信に失敗しました。');
            });
        }
    </script>
</body>
</html>
