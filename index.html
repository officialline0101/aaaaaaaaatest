<!DOCTYPE html>
<html lang="ja">
<head>
<base target="_top">
<meta http-equiv="content-type" charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@vuepic/vue-datepicker@latest/dist/main.css">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .dp__button {
        display: none;
    }
    * {
    	font-family:"游ゴシック Medium",YuGothic,YuGothicM,"Hiragino Kaku Gothic ProN","Hiragino Kaku Gothic Pro",メイリオ,Meiryo,sans-serif;
      }
    body {
    	margin:0;
    }
    header {
    	padding: 5px;
    	background-color: #333;
    	position: relative;
    }
    h2 {
    	text-align:center;
    	color: #fff;
    	margin: 10px;
    }
    .btn-group>.btn, .btn-group-vertical>.btn {
        float: none;
        display: inline-block;
    }
    .btn-info {
        color: #fff;
        background-color: #333;
        border-color: #FFF;
    }
    .btn-info:focus, .btn-info:active, .btn-info.active, .open>.dropdown-toggle.btn-info, .check {
        color: #333;
        background-color: #fff;
        border: solid 2px #333;
    }
    .container {
    	margin: 40px 0;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .use-span {
    	width: 25%;
    	font-size: 12px;
    	padding: 6px;
    	text-align: center;
    }
    .regist {
    	background:red;
    	border-color:red;
    	width: 100%;
    	padding: 20px 0;
    	margin: 20px 0;
    	color: #FFFFFF;
    }
    #error{
        display:none;
    }
    #section { display: none; }
    #family_count { display: none; }
    .dp__input {
        display: block;
        
        width: 100%;
        height: 34px;
        padding: 6px 12px;
        padding-left: 24px;
        font-size: 14px;
        line-height: 1.42857143;
        color: #555;
        background-color: #fff;
        background-image: none;
        border: 1px solid #ccc;
        border-radius: 4px;
        -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        -webkit-transition: border-color ease-in-out .15s,-webkit-box-shadow ease-in-out .15s;
        -o-transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
        transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
    }
    .dp__action_buttons {
        flex:auto;
    }
    input[type=radio] {
        display: none;
    }
    .flatpickr-day {
      position: relative;
    }
    .availability-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      padding: 2px 4px;
      font-size: 10px;
      line-height: 1;
      color: #000;
    }
</style>
</head>
<body>
<header>
	<h2>予約フォーム</h2>
</header>
<section id="app" class="container">
    <div class="form-group">
        <label for="name">お客様名</label>
        <input class="form-control" type="text" id="name" v-model="name">
    </div>
    <div class="form-group">
        <label for="tel">電話番号</label>
        <input class="form-control" type="tel" id="tel" v-model="tel">
    </div>
    <div class="form-group">
        <label for="number">来店回数</label>
        <div class="btn-group">
            <label class="btn btn-info use-span" :class="{'check':number == '初めて'}">
                <input type="radio" value="初めて" v-model="number">
                初めて
            </label>
            <label class="btn btn-info use-span" :class="{'check':number == '2回目以降'}">
                <input type="radio" value="2回目以降" v-model="number">
                2回目以降
            </label>
        </div>
    </div>
    <div class="form-group">
        <label for="syoujou">症状</label>
        <div class="btn-group-vertical">
            <label class="btn btn-info use-span" :class="{'check':syoujou == '肩こり'}">
                <input type="radio" value="肩こり" v-model="syoujou">
                肩こり
            </label>
            <label class="btn btn-info use-span" :class="{'check':syoujou == '腰痛'}">
                <input type="radio" value="腰痛" v-model="syoujou">
                腰痛
            </label>
            <label class="btn btn-info use-span" :class="{'check':syoujou == '頭痛'}">
                <input type="radio" value="頭痛" v-model="syoujou">
                頭痛
            </label>
            <label class="btn btn-info use-span" :class="{'check':syoujou == '手足のしびれ'}">
                <input type="radio" value="手足のしびれ" v-model="syoujou">
                手足のしびれ
            </label>
            <label class="btn btn-info use-span" :class="{'check':syoujou == '股関節の痛み'}">
                <input type="radio" value="股関節の痛み" v-model="syoujou">
                股関節の痛み
            </label>
            <label class="btn btn-info use-span" :class="{'check':syoujou == 'その他'}">
                <input type="radio" value="その他" v-model="syoujou">
                その他
            </label>
        </div>
    </div>
    <div class="form-group">
        <label>第1希望日</label>
        <div class="form-group">
            <input type="text" v-model="datepicker1" id="first-choice-date" placeholder="クリックして日時を入力">
        </div>
    </div>
    <div class="form-group">
        <label>第2希望日</label>
        <div class="form-group">
            <Datepicker v-model="datepicker2" placeholder="クリックして日時を入力" locale="jp" select-text="選択する" cancel-text="キャンセル" format="yyyy年MM月dd日" :disabled-week-days="[0]"></Datepicker>
        </div>
        <select class="form-control" v-model="datepicker2time">
            <option value="08:30">08:30</option>
            <option value="09:00">09:00</option>
            <option value="09:30">09:30</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
        </select>
    </div>
    <div class="form-group">
        <label>第3希望日</label>
        <div class="form-group">
            <Datepicker v-model="datepicker3" placeholder="クリックして日時を入力" locale="jp" select-text="選択する" cancel-text="キャンセル" format="yyyy年MM月dd日" :disabled-week-days="[0]"></Datepicker>
        </div>
        <select class="form-control" v-model="datepicker3time">
            <option value="08:30">08:30</option>
            <option value="09:00">09:00</option>
            <option value="09:30">09:30</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
        </select>
    </div>
    <div class="form-group">
        <label for="message">ご要望など</label>
        <textarea class="form-control" id="message" v-model="message"></textarea>
    </div>
    <button type="button" class="btn regist" @click="done()">送信</button>
</section>
<script>
const { createApp } = Vue;
import Datepicker from '@vuepic/vue-datepicker';
import '@vuepic/vue-datepicker/dist/main.css';

createApp({
    data(){
        return{
            name: '',
            tel: '',
            number: '',
            syoujou: '',
            datepicker1: '',
            datepicker1time: '08:30',
            datepicker2: '',
            datepicker2time: '08:30',
            datepicker3: '',
            datepicker3time: '08:30',
            message: ''
        }
    },
    components: {
        Datepicker,
    },
    methods: {
        get(){
            let params = {};
            let pr = location.search.substring(1).split('&');
            for(let i=0;pr[i];i++) {
                let kv = pr[i].split('=');
                params[kv[0]]=kv[1];
            }
            return params;
        },
        done(){
            liff.sendMessages([
            {
                type: 'text',
                text: `お客様名: ${this.name}\n電話番号: ${this.tel}\n来店回数: ${this.number}\n症状: ${this.syoujou}\n第1希望日: ${this.datepicker1} ${this.datepicker1time}\n第2希望日: ${this.datepicker2} ${this.datepicker2time}\n第3希望日: ${this.datepicker3} ${this.datepicker3time}\nご要望など: ${this.message}\n`
            }
            ]).then(() => {
                liff.closeWindow();
            }).catch((err) => {
                window.alert(`Error sending message: ${err}`);
            });
        },
    },
    mounted() {
        liff.init({
            liffId: "2004727608-aZejr9x5"
        }).then(()=>{
            if (liff.isLoggedIn()) {
                console.log("ログイン済");
            } else {
                liff.login();
            }
        });

    const updateAvailability = async (year, month) => {
        const response = await fetch(`YOUR_APPS_SCRIPT_DEPLOY_URL?year=${year}&month=${month}`);
        const availability = await response.json();
        
        document.querySelectorAll('.flatpickr-day').forEach(function(dayElem) {
            const date = dayElem.dateObj;
            const dateString = date.toISOString().split('T')[0];
            if (availability[dateString]) {
                const badge = document.createElement('div');
                badge.className = 'availability-badge';
                badge.textContent = availability[dateString];
                dayElem.appendChild(badge);
            }
        });
    };

    flatpickr("#first-choice-date", {
        onMonthChange: function(selectedDates, dateStr, instance) {
            const year = instance.currentYear;
            const month = instance.currentMonth;
            updateAvailability(year, month);
        },
        onYearChange: function(selectedDates, dateStr, instance) {
            const year = instance.currentYear;
            const month = instance.currentMonth;
            updateAvailability(year, month);
        },
        onReady: function(selectedDates, dateStr, instance) {
            const year = instance.currentYear;
            const month = instance.currentMonth;
            updateAvailability(year, month);
        }
    });
}
