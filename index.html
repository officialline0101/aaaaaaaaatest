<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1em;
      background-color: #fafafa;
    }
    h1 {
      text-align: center;
      margin-bottom: 1em;
    }
    #menu {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1em;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background-color: #eee;
    }
    .card-content {
      padding: 0.5em;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }
    .name {
      font-weight: bold;
      font-size: 1em;
      margin-bottom: 0.25em;
    }
    .price {
      color: #e53935;
      font-weight: bold;
      margin-bottom: 0.25em;
    }
    .category {
      font-size: 0.8em;
      color: #777;
      margin-bottom: 0.5em;
    }
    .description {
      font-size: 0.9em;
      color: #333;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    #loading {
      text-align: center;
      padding: 2em;
      font-size: 1.2em;
      color: #888;
    }
    button:focus {
      outline: none;
    }
    button:hover {
      opacity: 0.85;
    }
    #openCartBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 12px 16px;
      font-size: 18px;
      cursor: pointer;
      z-index: 999;
    }
    #cartModal {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 70%;
      background: white;
      border-top: 2px solid #ccc;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      overflow-y: auto;
      padding: 1em;
      z-index: 1000;
    }

/* gridã¨ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º */
#menu {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 1em;
}

.card img {
  width: 100%;
  height: auto;
  aspect-ratio: 4 / 3;
  object-fit: cover;
  background-color: #eee;
}

/* ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
.name {
  font-weight: bold;
  font-size: 1em;
  margin-bottom: 0.25em;
}
.price {
  color: #e53935;
  font-weight: bold;
  margin-bottom: 0.25em;
  font-size: 0.95em;
}
.category {
  font-size: 0.8em;
  color: #777;
  margin-bottom: 0.5em;
}
.description {
  font-size: 0.9em;
  color: #333;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

/* ã‚«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ”¹è‰¯ */
#cartModal {
  font-size: 14px;
  line-height: 1.5;
}

/* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚µã‚¤ã‚ºç”¨ */
@media screen and (max-width: 480px) {
  .name {
    font-size: 1.1em;
  }
  .price {
    font-size: 1em;
  }
  .description {
    font-size: 0.95em;
    -webkit-line-clamp: 4;
  }
  #openCartBtn {
    font-size: 16px;
    padding: 10px 14px;
  }
  #sortToggle {
    font-size: 0.9em;
    padding: 6px 10px;
  }
}
 
  </style>
</head>
<body>
<h1>ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§</h1>

<div style="text-align: center; margin-bottom: 1em;">
  <input type="text" id="searchInput" placeholder="æ–™ç†åãƒ»ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢" style="width: 80%; padding: 0.5em; font-size: 1em;">
</div>

<div id="categoryTabs" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5em; margin-bottom: 1em;"></div>

<div style="text-align: center; margin-bottom: 1em;">
  <button id="sortToggle" style="
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid #ccc;
    background: #fff;
    color: #333;
    cursor: pointer;
  ">ä¾¡æ ¼ï¼šå®‰ã„é †</button>
</div>

<div id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
<div id="menu" style="display: none;"></div>

<button id="openCartBtn">ğŸ›’ ã‚«ãƒ¼ãƒˆ</button>

<div id="cartModal">
  <h2>ğŸ› ã”æ³¨æ–‡ã‚«ãƒ¼ãƒˆ</h2>
  <div id="cartItems"></div>
  <button onclick="sendOrder()" style="
    margin-top: 1em;
    background-color: #4CAF50;
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
  ">âœ… ã“ã®å†…å®¹ã§æ³¨æ–‡ã™ã‚‹</button>
</div>

<script>
const apiUrl = 'https://script.google.com/macros/s/AKfycbyU7vrzHHFoIyqJLTzOGkD3kX89Ot9RUPRnYrdkm7_gWY-0QqtZPDZ3jhvJZs6Vuj7q/exec';
let allData = [], currentCategory = 'ã™ã¹ã¦', sortOrder = 'asc';

const getFavorites = () => JSON.parse(localStorage.getItem('favorites') || '[]');
const getCart = () => JSON.parse(localStorage.getItem('cart') || '[]');
const setCart = cart => localStorage.setItem('cart', JSON.stringify(cart));

function renderMenu(filteredData) {
  const container = document.getElementById('menu');
  container.innerHTML = '';
  const favs = getFavorites();

  filteredData.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    const img = document.createElement('img');
    img.src = item['ç”»åƒURL'] || '';
    img.alt = item['åå‰'];
    img.onerror = () => img.src = 'https://via.placeholder.com/160x120?text=No+Image';

    const content = document.createElement('div');
    content.className = 'card-content';
    content.innerHTML = `
      <div class="name">${item['åå‰']}</div>
      <div class="price">Â¥${item['ä¾¡æ ¼']}</div>
      <div class="category">${item['ã‚«ãƒ†ã‚´ãƒª']}</div>
      <div class="description">${item['èª¬æ˜']}</div>
    `;

    const favBtn = document.createElement('button');
    favBtn.innerHTML = favs.includes(item['åå‰']) ? 'â¤ï¸' : 'ğŸ¤';
    favBtn.style.alignSelf = 'flex-end';
    favBtn.style.border = 'none';
    favBtn.style.background = 'transparent';
    favBtn.style.cursor = 'pointer';
    favBtn.addEventListener('click', () => {
      let updated = getFavorites();
      if (updated.includes(item['åå‰'])) {
        updated = updated.filter(name => name !== item['åå‰']);
      } else {
        updated.push(item['åå‰']);
      }
      localStorage.setItem('favorites', JSON.stringify(updated));
      applyFilters();
    });
    content.appendChild(favBtn);

    const addBtn = document.createElement('button');
    addBtn.textContent = 'ğŸ›’ ã‚«ãƒ¼ãƒˆã«è¿½åŠ ';
    addBtn.style.marginTop = '6px';
    addBtn.style.padding = '6px';
    addBtn.style.backgroundColor = '#FF9800';
    addBtn.style.color = '#fff';
    addBtn.style.border = 'none';
    addBtn.style.borderRadius = '5px';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => {
      const cart = getCart();
      const existing = cart.find(i => i.name === item['åå‰']);
      if (existing) {
        existing.qty += 1;
      } else {
        cart.push({ name: item['åå‰'], price: parseInt(item['ä¾¡æ ¼']), qty: 1 });
      }
      setCart(cart);
      alert(`ã€Œ${item['åå‰']}ã€ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`);
    };
    content.appendChild(addBtn);

    card.appendChild(img);
    card.appendChild(content);
    container.appendChild(card);
  });
}

function applyFilters() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const favs = getFavorites();
  let filtered = allData.filter(item => {
    const matchCategory = currentCategory === 'ã™ã¹ã¦' ||
      (currentCategory === 'ãŠæ°—ã«å…¥ã‚Š' && favs.includes(item['åå‰'])) ||
      item['ã‚«ãƒ†ã‚´ãƒª'] === currentCategory;
    const matchSearch = item['åå‰'].toLowerCase().includes(query) || item['ã‚«ãƒ†ã‚´ãƒª'].toLowerCase().includes(query);
    return matchCategory && matchSearch;
  });
  filtered.sort((a, b) => sortOrder === 'asc' ? parseInt(a['ä¾¡æ ¼']) - parseInt(b['ä¾¡æ ¼']) : parseInt(b['ä¾¡æ ¼']) - parseInt(a['ä¾¡æ ¼']));
  renderMenu(filtered);
}

function renderCategoryTabs(data) {
  const container = document.getElementById('categoryTabs');
  const categories = [...new Set(data.map(item => item['ã‚«ãƒ†ã‚´ãƒª']))];
  categories.unshift('ã™ã¹ã¦');
  categories.push('ãŠæ°—ã«å…¥ã‚Š');
  container.innerHTML = '';
  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = cat;
    btn.style.padding = '6px 12px';
    btn.style.borderRadius = '20px';
    btn.style.border = '1px solid #ccc';
    btn.style.background = cat === currentCategory ? '#4CAF50' : '#fff';
    btn.style.color = cat === currentCategory ? '#fff' : '#333';
    btn.style.cursor = 'pointer';
    btn.addEventListener('click', () => {
      currentCategory = cat;
      renderCategoryTabs(data);
      applyFilters();
    });
    container.appendChild(btn);
  });
}

document.getElementById('sortToggle').addEventListener('click', () => {
  sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
  document.getElementById('sortToggle').textContent = sortOrder === 'asc' ? 'ä¾¡æ ¼ï¼šå®‰ã„é †' : 'ä¾¡æ ¼ï¼šé«˜ã„é †';
  applyFilters();
});

document.getElementById('searchInput').addEventListener('input', () => applyFilters());

document.getElementById('openCartBtn').addEventListener('click', () => {
  const modal = document.getElementById('cartModal');
  modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
  renderCart();
});

function renderCart() {
  const cart = getCart();
  const container = document.getElementById('cartItems');
  container.innerHTML = '';
  if (cart.length === 0) {
    container.innerHTML = '<p>ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™ã€‚</p>';
    return;
  }
  cart.forEach((item, i) => {
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    div.innerHTML = `
      <strong>${item.name}</strong><br>
      Â¥${item.price} Ã— 
      <button onclick="updateQty(${i}, -1)">âˆ’</button> 
      ${item.qty} 
      <button onclick="updateQty(${i}, 1)">ï¼‹</button>
      = <strong>Â¥${item.price * item.qty}</strong>
      <button onclick="removeItem(${i})" style="margin-left: 10px; color: red;">ğŸ—‘</button>
    `;
    container.appendChild(div);
  });
}

function updateQty(index, delta) {
  const cart = getCart();
  cart[index].qty += delta;
  if (cart[index].qty <= 0) cart.splice(index, 1);
  setCart(cart);
  renderCart();
}

function removeItem(index) {
  const cart = getCart();
  cart.splice(index, 1);
  setCart(cart);
  renderCart();
}

function sendOrder() {
  const cart = getCart();
  if (cart.length === 0) return alert("ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™");

  if (!confirm("ã“ã®å†…å®¹ã§æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) return;

  const payload = {
    items: cart
  };

  const formData = new FormData();
  formData.append("data", JSON.stringify(payload));

  fetch("https://script.google.com/macros/s/AKfycbyU7vrzHHFoIyqJLTzOGkD3kX89Ot9RUPRnYrdkm7_gWY-0QqtZPDZ3jhvJZs6Vuj7q/exec", {
    method: "POST",
    body: formData // â† Content-Type è‡ªå‹•
  })
    .then(res => res.text())
    .then(msg => {
      alert("æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
      localStorage.removeItem("cart");
      document.getElementById("cartModal").style.display = "none";
    })
    .catch(err => {
      alert("æ³¨æ–‡é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      console.error(err);
    });
}

fetch(apiUrl)
  .then(response => response.json())
  .then(data => {
    allData = data;
    document.getElementById('loading').style.display = 'none';
    document.getElementById('menu').style.display = 'grid';
    renderCategoryTabs(allData);
    renderMenu(allData);
  })
  .catch(err => {
    document.getElementById('loading').textContent = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    console.error(err);
  });
</script>
</body>
</html>
