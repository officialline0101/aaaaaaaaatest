<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ひなた助産院 予約リンク</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7fafc;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
      padding: 24px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 1.4rem;
      margin-top: 0;
      margin-bottom: 12px;
      color: #1a202c;
    }
    p {
      line-height: 1.7;
      color: #4a5568;
      font-size: 0.95rem;
    }
    .token-info {
      font-size: 0.8rem;
      color: #718096;
      margin-top: 8px;
    }
    .alert {
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }
    .alert-error {
      background: #fff5f5;
      border: 1px solid #feb2b2;
      color: #c53030;
    }
    .alert-warn {
      background: #fffff0;
      border: 1px solid #faf089;
      color: #975a16;
    }
    .btn-row {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    button, .btn-link {
      border-radius: 999px;
      border: none;
      padding: 10px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .btn-primary {
      background: #3182ce;
      color: #fff;
    }
    .btn-danger {
      background: #e53e3e;
      color: #fff;
    }
    .btn-ghost {
      background: #edf2f7;
      color: #4a5568;
    }
    .btn-primary:hover   { background: #2b6cb0; }
    .btn-danger:hover    { background: #c53030; }
    .btn-ghost:hover     { background: #e2e8f0; }

    .hidden { display: none; }

    .field {
      margin-top: 16px;
    }
    .field label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #4a5568;
    }
    .field input[type="datetime-local"] {
      width: 100%;
      padding: 8px 10px;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1px solid #cbd5e0;
      box-sizing: border-box;
    }
    footer {
      margin-top: 20px;
      font-size: 0.75rem;
      color: #a0aec0;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">予約リンク</h1>
    <p id="description">
      メールに記載されたリンクから、このページを開いてください。
    </p>

    <div id="warning-box" class="alert alert-warn hidden"></div>
    <div id="error-box" class="alert alert-error hidden"></div>

    <div id="reschedule-box" class="hidden">
      <div class="field">
        <label for="new-start">新しいご希望日時</label>
        <input type="datetime-local" id="new-start" />
      </div>
    </div>

    <div class="btn-row" id="button-row" class="hidden">
      <!-- JSでボタンを差し込む -->
    </div>

    <p class="token-info" id="token-info"></p>

    <footer>
      ひなた助産院 予約リンクページ
    </footer>
  </div>

  <script>
    // ★ あなたの Apps Script Web アプリ URL に変更してください
    const API_BASE = "https://script.google.com/macros/s/AKfycbzx-en3Ayrnsiu3HP8IxZ_p-Di2aBYAtPj3sOgQiNEJ4BZjCJjMpQ9jAdDNGH44ss97VQ/exec";

    const titleEl = document.getElementById("title");
    const descEl = document.getElementById("description");
    const warnEl = document.getElementById("warning-box");
    const errorEl = document.getElementById("error-box");
    const btnRowEl = document.getElementById("button-row");
    const tokenInfoEl = document.getElementById("token-info");
    const rescheduleBoxEl = document.getElementById("reschedule-box");
    const newStartInput = document.getElementById("new-start");

    function showError(msg) {
      errorEl.textContent = msg;
      errorEl.classList.remove("hidden");
    }

    function showWarn(msg) {
      warnEl.textContent = msg;
      warnEl.classList.remove("hidden");
    }

    function clearButtons() {
      btnRowEl.innerHTML = "";
    }

    function addButton(label, className, onClick) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = label;
      btn.className = className;
      btn.addEventListener("click", onClick);
      btnRowEl.appendChild(btn);
    }

    function decodeTokenPayload(token) {
      try {
        const parts = token.split(".");
        if (parts.length < 2) return null;
        let b64 = parts[0].replace(/-/g, "+").replace(/_/g, "/");
        while (b64.length % 4 !== 0) {
          b64 += "=";
        }
        const json = atob(b64);
        return JSON.parse(json);
      } catch (e) {
        console.error(e);
        return null;
      }
    }

    function buildApiUrl(op, token, extraParams) {
      const url = new URL(API_BASE);
      url.searchParams.set("op", op);
      url.searchParams.set("token", token);
      if (extraParams) {
        Object.keys(extraParams).forEach(k => {
          url.searchParams.set(k, extraParams[k]);
        });
      }
      return url.toString();
    }

    function init() {
      const params = new URLSearchParams(location.search);
      const token = params.get("token");

      if (!token) {
        showError("トークンが指定されていません。このページは、予約メール内のリンクから開いてください。");
        return;
      }

      const payload = decodeTokenPayload(token);
      if (!payload) {
        showError("トークンの内容を読み取れませんでした。リンクが壊れている可能性があります。");
        return;
      }

      const op = payload.op || "view";
      const exp = payload.exp ? new Date(payload.exp * 1000) : null;
      const resvId = payload.resvId || "";

      // トークン情報を画面下部に表示（デバッグ兼用）
      tokenInfoEl.textContent =
        "操作種別: " + op +
        (resvId ? " ／ 予約ID: " + resvId : "") +
        (exp ? " ／ 有効期限: " + exp.toLocaleString("ja-JP") : "");

      if (exp && exp.getTime() < Date.now()) {
        showWarn("このリンクの有効期限が切れている可能性があります。実行してもエラーになる場合があります。");
      }

      btnRowEl.classList.remove("hidden");

      switch (op) {
        case "view":
          setupView(token);
          break;
        case "confirm":
          setupConfirm(token);
          break;
        case "cancel":
          setupCancel(token);
          break;
        case "reschedule":
          setupReschedule(token);
          break;
        default:
          showError("不明な操作が指定されています: " + op);
      }
    }

    function setupView(token) {
      titleEl.textContent = "ご予約内容の確認";
      descEl.textContent = "予約内容の詳細ページに移動します。数秒待っても切り替わらない場合は、下のボタンをクリックしてください。";

      clearButtons();
      addButton("予約内容ページへ移動", "btn-primary", function () {
        const url = buildApiUrl("view", token);
        window.location.href = url;
      });

      // 2秒後に自動で遷移（ユーザー操作なしでもOKにしたい場合）
      setTimeout(function () {
        const url = buildApiUrl("view", token);
        window.location.href = url;
      }, 2000);
    }

    function setupConfirm(token) {
      titleEl.textContent = "ご予約の確定";
      descEl.textContent =
        "メールに記載されているご予約を「確定」します。\n" +
        "内容にお間違いがなければ、下のボタンを押してください。";

      clearButtons();
      addButton("この予約を確定する", "btn-primary", function () {
        if (!confirm("この予約を確定しますか？")) return;
        const url = buildApiUrl("confirm", token);
        window.location.href = url;
      });
      addButton("何もしないで閉じる", "btn-ghost", function () {
        window.close();
      });
    }

    function setupCancel(token) {
      titleEl.textContent = "ご予約のキャンセル";
      descEl.textContent =
        "メールに記載されているご予約をキャンセルします。\n" +
        "キャンセルポリシー（キャンセル料など）を必ずご確認のうえ、実行してください。";

      clearButtons();
      addButton("この予約をキャンセルする", "btn-danger", function () {
        if (!confirm("本当にこの予約をキャンセルしますか？")) return;
        const url = buildApiUrl("cancel", token);
        window.location.href = url;
      });
      addButton("キャンセルせずに閉じる", "btn-ghost", function () {
        window.close();
      });
    }

    function setupReschedule(token) {
      titleEl.textContent = "ご予約日時の変更";
      descEl.textContent =
        "ご希望の新しい日時を入力し、「日時を変更する」ボタンを押してください。\n" +
        "営業時間外や他の予約と重複している場合はエラーになります。";

      rescheduleBoxEl.classList.remove("hidden");

      clearButtons();
      addButton("日時を変更する", "btn-primary", function () {
        const v = newStartInput.value; // "YYYY-MM-DDTHH:MM"
        if (!v) {
          alert("新しい日時を入力してください。");
          return;
        }
        // Apps Script 側の期待形式: "YYYY-MM-DDTHH:mm:ss+09:00"
        const newStartIso = v + ":00+09:00";
        if (!confirm("この日時に変更しますか？\n\n" + v.replace("T", " "))) return;

        const url = buildApiUrl("reschedule", token, { newStartIso: newStartIso });
        window.location.href = url;
      });

      addButton("変更せずに閉じる", "btn-ghost", function () {
        window.close();
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
