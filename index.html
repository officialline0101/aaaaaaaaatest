<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店舗名テスト 予約フォーム</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
         
        body { font-family: 'Poppins', sans-serif; background-color: #ffffff; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding-top: 5px; overflow-x: hidden; }
        .container { background-color: #fdfdfd; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); width: 90%; max-width: 500px; padding: 25px; box-sizing: border-box; margin: 0 auto; padding-bottom: 80px; }
        h1 { background: linear-gradient(135deg, #13ca5e, #13ca5e); color: white; padding: 20px; border-radius: 0; text-align: center; margin: -25px -25px 20px -25px; font-size: 24px; font-weight: 100; box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.05); }
        .label, .labeltyuuou { display: block; margin-bottom: 15px; padding: 5px; background-color: #13ca5e; color: #ffffff; font-size: 16px; text-align: center; border-top: 1px solid black; border-bottom: 1px solid black; }
        .label { text-align: left; padding-left: 20px; }
        .labeltyuuou { font-weight: bold; }
        .required { color: #ffffff; font-size: 0.7em; margin-left: 10px; background-color: rgb(255, 15, 15); padding: 2px 6px; border-radius: 4px; vertical-align: middle; }
        input[type="text"], input[type="tel"], textarea { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #555555; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        input:focus, textarea:focus { border-color: #13ca5e; outline: none; box-shadow: 0 0 5px rgba(19, 202, 94, 0.5); }
        .visit-buttons, .menu-sections, .symptoms, .dynamic-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .visit-buttons button, .menu-sections button, .symptoms button, .dynamic-buttons button { flex: 1; min-width: 45%; padding: 12px; border: 1px solid #2e2e2e; border-radius: 4px; background-color: #f7f7f7; cursor: pointer; text-align: center; font-size: 14px; transition: all 0.2s; }
        button.active { background-color: #ffffff; color: #141414; outline: 2px solid #13ca5e; border-color: #13ca5e; font-weight: bold; }
        .menu-section { display: none; }
        .menu-section.active { display: block; }
        #treatment-text { background-color: #f9f9f9; padding: 15px; border: 1px solid #ddd; border-left: 4px solid #13ca5e; margin-bottom: 20px; font-size: 14px; display: none; }
        .calendar-container { display: none; margin-bottom: 20px; width: 100%; }
        .calendar { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .calendar th, .calendar td { border: 1px solid #ccc; padding: 8px 2px; text-align: center; font-size: 12px; }
        .calendar th { background: #f0f0f0; }
        .calendar td.available { color: #13ca5e; font-weight: bold; cursor: pointer; }
        .calendar td.unavailable { background-color: #eee; color: #ccc; pointer-events: none; }
        .calendar td.selected { background-color: #13ca5e; color: white; }
        .nav-btn-container { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .nav-btn { padding: 5px 15px; background: white; border: 1px solid #333; border-radius: 4px; cursor: pointer; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dashed #ccc; }
        .info-row p { margin: 0; font-size: 14px; }
        .info-label { background: #333; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 5px; }
        .edit-button { padding: 2px 8px; font-size: 12px; background: white; border: 1px solid #333; border-radius: 3px; cursor: pointer; }
        .submit-button { width: 100%; padding: 15px; background-color: #13ca5e; color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .submit-button:hover { opacity: 0.9; }
        .side-nav { position: fixed; right: 0; top: 70%; background: #13ca5e; padding: 10px 5px; border-radius: 10px 0 0 10px; color: white; text-align: center; cursor: pointer; z-index: 999; }
        .loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 8px; z-index: 1000; }
        .current-month { text-align: center; display: block; position: absolute; left: 50%; transform: translate(-50%, -10px); background-color: #3e3f41; color: #fff; padding: 3px 12px; border-radius: 8px; font-size: 1.2rem; font-weight: 300; box-shadow: 0 2px 6px rgba(47, 103, 167, 0.2); }
        .month-button-container { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; }
        .month-button, .week-button { padding: 8px 15px; background-color: #ffffff; color: #222222; border: 1px solid black; border-radius: 4px; cursor: pointer; }
    </style>
</head>

<body>
    <div class="side-nav" onclick="document.getElementById('section-confirm').scrollIntoView({behavior: 'smooth'})">
        <div style="font-size:20px;">⇩</div>
        <div style="font-size:10px;">予約</div>
    </div>

    <div class="container">
        <h1>店舗名テスト<br>予約フォーム</h1>
        
                                            
                            <div class="label">お客様名<span class="required">必須</span></div>
                <input type="text" id="name" placeholder="お名前を入力してください" oninput="updateDisplayInfo()">

                                                        
                            <div class="label">電話番号<span class="required">必須</span></div>
                <input type="tel" id="phone" placeholder="電話番号を入力してください" oninput="updateDisplayInfo()">

                                                        
                            <div class="label" id="lbl_visit">ご来店回数<span class="required">必須</span></div>
                <div class="visit-buttons">
                                                                <button type="button" onclick="selectVisit(this, '初回')">初回</button>
                                            <button type="button" onclick="selectVisit(this, '2回目以降')">2回目以降</button>
                                    </div>

                    
        <div class="label" id="lbl_menu">メニューをお選びください<span class="required">必須</span></div>
        <div style="text-align:center; font-size:13px; background:#eee; padding:5px; margin-bottom:15px;">※メニューを選択するとカレンダーが表示されます</div>
        
        <div class="menu-sections">
                            <button type="button" onclick="showCategory('cat_0')">未設定</button>
                    </div>

        <div id="treatment-text"></div>

                    <div id="cat_0" class="menu-section">
                <div class="labeltyuuou">◆未設定◆</div>
                <div class="symptoms">
                                                                    <button type="button" 
                                onclick="selectMenu(this)" 
                                data-name="あ"
                                data-price="2000"
                                data-time="60">
                            あ〈60分〉
                        </button>
                                    </div>
            </div>
        
        <div class="label" id="lbl_date">希望日時<span class="required">必須</span></div>
        <div class="calendar-container">
            <div style="position:relative; height:40px; margin-bottom:10px;">
                <span class="current-month" id="currentMonthDisp"></span>
            </div>
            
            <div class="month-button-container">
                <button class="month-button" onclick="moveMonth(-1)">前月</button>
                <button class="month-button" onclick="moveMonth(1)">翌月</button>
            </div>
            <div class="week-button-container">
                <button class="week-button" onclick="moveWeek(-1)">前週</button>
                <button class="week-button" onclick="moveWeek(1)">次週</button>
            </div>

            <div id="calendar1" class="calendar">
                <table id="calendarTable">
                    <thead>
                        <tr id="calendarHeader">
                            <th style="width:15%">時間</th>
                            <th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <div class="loading-text">読み込み中...</div>
        </div>

        <div class="labeltyuuou">メッセージ</div>
        <textarea id="message" rows="3" placeholder="ご質問などあれば"></textarea>

        <div class="labeltyuuou" id="section-confirm">ご予約内容確認</div>
        <div id="displayInfo"></div>

        <button class="submit-button" onclick="submitForm()">予約を行う</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        
        
        const timeSlots = ["10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30"];

        
        let currentDate = new Date();
        let selectedDate = null;
        let visitTime = 0;
        let menuTime = 0;
        let menuPrice = 0;
        let selectedMenuName = "";
        let visitCountVal = "";
        let availData = []; 

        
        document.addEventListener('DOMContentLoaded', () => {
            liff.init({ liffId: '2005254357-zKma9BZk' }).then(() => console.log('LIFF Ready')).catch(console.error);
            
            
            fetchAvailability(currentDate);
            updateDisplayInfo();
        });

        
        function saveInput(id) { localStorage.setItem(id, document.getElementById(id).value); }

        function selectDynamicBtn(btn, inputId, labelName) {
            btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const input = document.getElementById(inputId);
            if(input) { input.value = btn.innerText; updateDisplayInfo(); }
        }

        
        function selectVisit(btn, text) {
            btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            visitCountVal = text;
            
            
            const match = text.match(/〈(\d+)分〉/);
            visitTime = match ? parseInt(match[1]) : 0;
            
            renderCalendar(); 
            updateDisplayInfo();
        }

        function showCategory(catId) {
            document.querySelectorAll('.menu-section').forEach(el => el.style.display = 'none');
            document.getElementById(catId).style.display = 'block';
            
            document.querySelectorAll('.menu-sections button').forEach(b => {
                if(b.getAttribute('onclick').includes(catId)) b.classList.add('active');
                else b.classList.remove('active');
            });
        }

        function selectMenu(btn) {
            document.querySelectorAll('.symptoms button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            selectedMenuName = btn.getAttribute('data-name');
            menuPrice = parseInt(btn.getAttribute('data-price'));
            menuTime = parseInt(btn.getAttribute('data-time'));

            const infoBox = document.getElementById('treatment-text');
            infoBox.style.display = 'block';
            infoBox.innerHTML = `
                <div><strong>選択メニュー:</strong> ${selectedMenuName}</div>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span>所要時間: ${menuTime}分</span>
                    <span style="font-weight:bold; color:#13ca5e;">¥${menuPrice.toLocaleString()}</span>
                </div>
            `;
            
            // カレンダーを表示
            document.querySelector('.calendar-container').style.display = 'block';
            selectedDate = null; 
            
            renderCalendar(); 
            updateDisplayInfo();
        }

        
        async function fetchAvailability(date) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = 'block';

            const start = new Date(date);
            const end = new Date(date);
            end.setDate(end.getDate() + 7);

            
            const url = 'https://script.google.com/macros/s/AKfycbzgesmVv83Oy7jRS_DoiYgk8NqB50jD7NzUGGmjHoAxnaKwBVDbRzjFIbm5sIvJJbHA/exec' + 
                        `?startTime=${start.toISOString()}&endTime=${end.toISOString()}`;
            
            try {
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    if (Array.isArray(data)) availData = data;
                    else if (data && Array.isArray(data.events)) availData = data.events;
                    else availData = [];
                } else {
                    console.error("API Error");
                    availData = [];
                }
            } catch(e) {
                console.error("Fetch Failed:", e);
                availData = []; 
            } finally {
                spinner.style.display = 'none';
                renderCalendar(); 
            }
        }

        function renderCalendar() {
            const tableBody = document.querySelector('#calendarTable tbody');
            const headerRow = document.getElementById('calendarHeader');
            tableBody.innerHTML = ''; 

            
            document.getElementById('currentMonthDisp').innerText = 
                `${currentDate.getFullYear()}年 ${currentDate.getMonth()+1}月`;

            
            const headers = headerRow.querySelectorAll('th:not(:first-child)');
            const weekDays = ['日','月','火','水','木','金','土'];
            
            for(let i=0; i<7; i++) {
                const d = new Date(currentDate);
                d.setDate(d.getDate() + i);
                headers[i].innerHTML = `${d.getDate()}<br>(${weekDays[d.getDay()]})`;
                if(d.getDay()===0) headers[i].style.color='red';
                else if(d.getDay()===6) headers[i].style.color='blue';
                else headers[i].style.color='';
            }

            
            timeSlots.forEach(timeStr => {
                const tr = document.createElement('tr');
                const tdTime = document.createElement('td');
                tdTime.innerText = timeStr;
                tdTime.style.background = '#f9f9f9';
                tr.appendChild(tdTime);

                for(let i=0; i<7; i++) {
                    const td = document.createElement('td');
                    const cellDate = new Date(currentDate);
                    cellDate.setDate(cellDate.getDate() + i);
                    
                    const [hh, mm] = timeStr.split(':');
                    cellDate.setHours(parseInt(hh), parseInt(mm), 0, 0);

                    
                    const status = checkAvailability(cellDate); 
                    
                    if(status === 'ok') {
                        td.innerText = '◯';
                        td.className = 'available';
                        td.onclick = () => selectDate(td, cellDate);
                    } else {
                        td.innerText = '✕';
                        td.className = 'unavailable';
                    }
                    tr.appendChild(td);
                }
                tableBody.appendChild(tr);
            });
        }

        function checkAvailability(slotStart) {
            if(slotStart < new Date()) return 'ng'; 

            const totalDuration = (menuTime || 30) + visitTime;
            const slotEnd = new Date(slotStart);
            slotEnd.setMinutes(slotEnd.getMinutes() + totalDuration);

            if(slotEnd.getDate() !== slotStart.getDate()) return 'ng'; 

            
            if(availData.length === 0) return 'ng';

            const conflicts = availData.filter(evt => {
                const evtStart = new Date(evt.startTime);
                const evtEnd = new Date(evt.endTime);
                if(evt.summary === '営業日' || evt.title === '営業日') return false;
                return (evtStart < slotEnd && slotStart < evtEnd);
            });

            if(conflicts.length > 0) return 'ng'; 

            const hasBusinessData = availData.some(e => e.summary === '営業日' || e.title === '営業日');
            if(hasBusinessData) {
                const businessDay = availData.find(evt => {
                    return (evt.summary === '営業日' || evt.title === '営業日') &&
                           new Date(evt.startTime) <= slotStart &&
                           new Date(evt.endTime) >= slotEnd;
                });
                if(!businessDay) return 'ng';
            }

            return 'ok';
        }

        function selectDate(td, dateObj) {
            document.querySelectorAll('.calendar td').forEach(c => c.classList.remove('selected'));
            td.classList.add('selected');
            const y = dateObj.getFullYear();
            const m = dateObj.getMonth() + 1;
            const d = dateObj.getDate();
            const time = `${('0'+dateObj.getHours()).slice(-2)}:${('0'+dateObj.getMinutes()).slice(-2)}`;
            selectedDate = `${y}年${m}月${d}日 ${time}`;
            updateDisplayInfo();
        }

        function moveMonth(dir) {
            currentDate.setMonth(currentDate.getMonth() + dir);
            currentDate.setDate(1);
            fetchAvailability(currentDate);
        }

        function moveWeek(dir) {
            currentDate.setDate(currentDate.getDate() + (dir * 7));
            fetchAvailability(currentDate);
        }

        function updateDisplayInfo() {
            const disp = document.getElementById('displayInfo');
            let html = "";
            
            const name = document.getElementById('name') ? document.getElementById('name').value : "";
            if(name) html += row("お名前", name, "name");

            const phone = document.getElementById('phone') ? document.getElementById('phone').value : "";
            if(phone) html += row("電話番号", phone, "phone");

            if(visitCountVal) html += row("来店回数", visitCountVal, "lbl_visit");

            document.querySelectorAll('input[id^="field_"]').forEach(inp => {
                if(inp.value) html += row(inp.getAttribute('data-label'), inp.value, "lbl_" + inp.id);
            });

            if(selectedMenuName) html += row("メニュー", selectedMenuName, "lbl_menu");

            if(menuTime > 0) {
                const totalM = menuTime + visitTime;
                html += row("所要時間", `${totalM}分`, "");
                html += row("合計金額", `¥${menuPrice.toLocaleString()}`, "");
            }

            if(selectedDate) html += row("希望日時", selectedDate, "lbl_date");

            disp.innerHTML = html;
        }

        function row(label, val, targetId) {
            return `<div class="info-row"><div><span class="info-label">${label}</span> ${val}</div>${targetId ? `<button class="edit-button" onclick="scrollToId('${targetId}')">修正</button>` : ''}</div>`;
        }

        function scrollToId(id) {
            const el = document.getElementById(id);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function submitForm() {
            const errors = [];
            const data = {};

            const nameEl = document.getElementById('name');
            if(nameEl && !nameEl.value) errors.push("お名前");
            if(nameEl) data["お名前"] = nameEl.value;

            const phoneEl = document.getElementById('phone');
            if(phoneEl && !phoneEl.value) errors.push("電話番号");
            if(phoneEl) data["電話番号"] = phoneEl.value;

            if(document.getElementById('lbl_visit') && !visitCountVal) errors.push("来店回数");
            data["来店回数"] = visitCountVal;

            document.querySelectorAll('input[id^="field_"]').forEach(inp => {
                const label = inp.getAttribute('data-label');
                const req = inp.getAttribute('data-required') === 'true';
                if(req && !inp.value) errors.push(label);
                data[label] = inp.value;
            });

            if(!selectedMenuName) errors.push("メニュー");
            data["メニュー"] = selectedMenuName;
            
            if(!selectedDate) errors.push("希望日時");
            data["希望日時"] = selectedDate;

            data["メッセージ"] = document.getElementById('message').value;

            if(errors.length > 0) {
                alert("以下の必須項目が未入力です:\n" + errors.join(", "));
                return;
            }

            let msg = "【予約フォーム送信】\n";
            for(let key in data) { if(data[key]) msg += `${key}：${data[key]}\n`; }

            liff.sendMessages([{ type: 'text', text: msg }])
                .then(() => { alert("予約を送信しました！"); liff.closeWindow(); })
                .catch(err => { alert("送信エラー"); console.error(err); });
        }
    </script>
</body>
</html>
